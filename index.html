<!DOCTYPE html>
<html>
 <head>
 <meta charset="utf-8">
 <title>RADARBOY **ASCII** MAPS</title>

<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDSoM9HgrTGLXgnm9mjzDY0194TPVx0mtw"></script>
<script src="../../code365/js/html2canvas.js"></script>
<script src="../../code365/js/canvas.js"></script>
<script language="javascript" src="../../code365/js/creative_coding.js"></script>
<script language="javascript" src="../../code365/js/fx.js"></script>
<script language="javascript" src="../../code365/js/jquery-1.10.1.min.js"></script>
<script type="text/javascript" src="../../code365/js/controlKit.min.js"></script>
<style type="text/css">
body {
  background: #fff;
  overflow: hidden;
  font-size: 22px;
  font-family: Courier, Helvetica, sans;
}
#c {
  pointer-events: none;
}

#loading_holder {
  width: 100%;
  height: 100%;
  position: absolute;
  left: 0;
  top: 0;
  pointer-events: none;
}
#loading {
  width: 300px;
  z-index: 222;
  margin: 30% auto 0% auto;
  background: #fff;
  position: relative;
  text-align: center;
  padding: 6px;
}


#city {
  display: none;
  position: absolute;
  bottom: 0px;
  width: 100%;
  left: 0;
  padding: 20px;
  text-align: center;
  font-size: 18px;
  color: #000;
  background: #fff;
  z-index: 999;
}
</style>
<body>


<div id="map" style='height:550px; width:100%; position: absolute; left:0; top: 0;'></div>


<div id="loading_holder">
  <div id="loading">Image Crunching...</div>
</div>

<div id="city"></div>


<script>
var ctx = createCanvas("c");
var m = document.getElementById("map");
m.width=window.innerWidth;
m.height=window.innerHeight;

var img = new Image();
var map;
var letterOrder =
  " .`-_':,;^=+/\"|)\\<>)iv%xclrs{*}I?!][1taeo7zjLu" +
  "nT#JCwfy325Fp6mqSghVd4EgXPGZbYkOA&8U$@KHDBWNMR0Q";
var letters = [];
var bright= [];
var chars= [];

function initialize() {
	  var customMapType = new google.maps.StyledMapType([
      {
        stylers: [
          {hue: rgb(182,253,255)},
          {visibility: 'simplified'},
          //{gamma: 0.7},
          //{weight: 0.5}
        ]
      },
      {
        elementType: 'labels',
        stylers: [{visibility: 'off'}]
      },
      {
        featureType: 'water',
        stylers: [{color: rgb(255,255,255)}]
      }
    ], {
      name: 'Custom Style'
  });
  var customMapTypeId = 'custom_style';

  var mapProp = {
    center:new google.maps.LatLng(51.508742,-0.120850),
    zoom:5,
    streetViewControl: false,
    zoomControl: true,
    mapTypeControl: false,
          zoomControlOptions: {
              position: google.maps.ControlPosition.LEFT_TOP
    },
    // mapTypeId:google.maps.MapTypeId.SATELLITE
    //mapTypeId:google.maps.MapTypeId.TERRAIN
    mapTypeId:google.maps.MapTypeId.ROADMAP
  };

 	map=new google.maps.Map(document.getElementById("map"),mapProp);
 	map.mapTypes.set(customMapTypeId, customMapType);
  	map.setMapTypeId(customMapTypeId);

 	resizeMapDiv();
    //$(window).resize(map.resizeMapDiv);

	google.maps.event.addListener(map, 'tilesloaded', function(){
    	getImage();
	});
	google.maps.event.addDomListener(map, 'drag',
		function(){
			$("#c").fadeOut();	});
	google.maps.event.addDomListener(map, 'zoom',
		function(){
		$("#c").fadeOut();	});
	google.maps.event.addDomListener(map, 'click',
		function(){
		$("#c").fadeOut();	});
	}


	var url = 'proxy.php?'
	function setup(){
		initialize();
	}

resizeMapDiv = function () {
    $("#map").height($(window).height());
    $("#map").width($(window).width());
    google.maps.event.trigger(map, 'resize');
}



function getImage(){
    console.log("getImage");
    $('#loading_holder').fadeIn();
    $('#city').fadeOut();
    var transform=$(".gm-style>div:first>div").css("transform")
    var comp=transform.split(",") //split up the transform matrix
    var mapleft=parseFloat(comp[4]) //get left value
    var maptop=parseFloat(comp[5])  //get top value
    $(".gm-style>div:first>div").css({ //get the map container. not sure if stable
        "transform":"none",
        "left":mapleft,
        "top":maptop,
    })

latlng = map.getCenter().toUrlValue();
nearestCity(map.getCenter().lat(), map.getCenter().lng());

html2canvas($('#map'),
{
   //"logging": true,
   "proxy":"scripts/proxy.php",
  // useCORS: true,
  onrendered: function(canvas) {

    img.src = canvas.toDataURL("image/png");

    img.onload = function() {
        img.onload = null;
        $("#c").fadeIn();
        ctx.drawImage(img, 0, 0, window.innerWidth,window.innerHeight);
        $(".gm-style>div:first>div").css({
            left:0, top:0, "transform":transform
        })

        asciiFy();
    };

  }
});

}


function nearestCity(lat, lng){

  var url = 'http://api.geonames.org/findNearbyPlaceNameJSON?lat=' + lat + '&lng=' + lng + '&radius=300&maxRows=1&username=radarboy';
   $.ajax({
      url: url,
      success:function(data) {
        //var place = jQuery.parseJSON(data);
        for (key in data.geonames) {
          var place = data.geonames[key];
          console.log(place.name);

          if (place.name == undefined || place.name == null) {
            $("#city").text("Nearest City: Middle of nowhere");
          } else {
            $("#city").text("Nearest City: " + place.name + ", " + place.countryName);
          }

        }
      }
   });

}


var blockSize = 10;
var fontSize = 18;
var colourType = "green";
var bg = 0;

	function asciiFy(){
    $('#loading_holder').fadeOut("slow");
    $('#city').fadeIn("slow");
		ctx.drawText({fontSize: fontSize, blockSize: blockSize, background: bg, colourType: colourType});
	}




  var object = {
      blockSize : blockSize,
      fontSize : fontSize,
      range: [5, 50],
      colour_range: ["red", "blue", "green", "all"],
  }

  var controlKit = new ControlKit();
  controlKit.addPanel({
    label: 'Options',
    align: 'left',
    fixed: false,
    position: [w-220, 20],
    width: 200
  })
    //.addGroup({ label: 'Pixel Sizes'})
       .addSlider(object, 'blockSize', 'range', { label: 'Sample Size', dp: 0, onChange: function(index){
      	blockSize =  object.blockSize;
      	getImage(); }})

        .addSlider(object, 'fontSize', 'range', { label: 'Font Size', dp: 0, onChange: function(index){
       	fontSize =  object.fontSize;
       	getImage(); }})

      //.addGroup({ label: 'Colours'})
    .addButton('Red',function(){colourType = "red"; bg = 0; getImage();})
    .addButton('Blue',function(){colourType = "blue"; bg = 0; getImage();})
    .addButton('Green',function(){colourType = "green"; bg = 0; getImage();})
    .addButton('Full Colour',function(){ colourType = "all"; bg = "none";getImage();})

    .addGroup();

</script>


 </body>
</html>
